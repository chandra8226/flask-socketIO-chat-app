<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin="anonymous" />

    <title>My Flask Socket Chat App</title>
    
    <link rel="shortcut icon" href="{{url_for('static',filename='favicon.png')}}" type="image/x-icon">
  </head>
  <body>
    
    <nav class="navbar navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand mb-0 h1" href="{{url_for('home')}}">My Flask Socket Chat App</a>
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="{{url_for('logout')}}"  style="color:white;">Logout</a>
          </li>
      </ul>
      </div>
    </nav>
    
  <div class="container mt-5">
    <div class="row">
      <div class="col-sm-8">
        <div class="no_message">
          <h1 id="h1" style='color: #ccc'>No messages yet...</h1>
          <div class="message_holder" id="message_holder"></div>
        </div>
      </div>
      <div class="col-sm-4">
        <form id="form">
          <div class="mb-3">
            <b>Type your message below <span class="fas fa-arrow-down"></span></b>
          </div>
          <hr>
          <div class="mt-4 mb-2">
            <label for="username" class="form-label"><b>Username</b></label>
            <input type="text" class="username form-control" id="username" placeholder="Username" value="{{username}}" readonly>
          </div>
          <div class="mb-3">
            <label for="message" class="form-label"><b>Messages</b></label>
            <input type="text" class="message form-control" id="message" placeholder="Messages">
          </div>
          <button type="submit" class="btn btn-success"><b>Send <span class="fas fa-paper-plane"></span></b></button>
        </form>
      </div>
    </div>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.1/socket.io.js"></script>

  <script>
    // var socket = io.connect('http://127.0.0.1:5000/');
    document.addEventListener('DOMContentLoaded', () => {
    var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
    
    socket.on('connect',function(){
      socket.emit( 'my event', {
        data: '{{username}} Connected'
      });
    });
    
    var form = document.getElementById('form')
    form.addEventListener('submit',function(e){
      e.preventDefault();
      var user_name = document.getElementById('username').value;
      var message = document.getElementById('message').value;
      socket.emit('my event',{
        user : user_name,
        msg : message
      })
      document.getElementById('message').value = "";
      document.getElementById('message').focus();
    });
    
    socket.addEventListener('my response',function(msg){
      if(typeof msg.user != 'undefined') {
        var node = document.getElementById('h1');
        if(node){
          node.remove();
        }
        var tag = document.createElement("p");
        tag.innerHTML = `<b>`+msg.user+`</b> : `+msg.msg;
        var element = document.getElementById("message_holder");
        element.appendChild(tag);
      }
      console.log(msg);
    });
    
    window.addEventListener('beforeunload',function(e) {
      e.preventDefault();
      socket.emit('my event', {
        data: '{{username}} Disconnected'
      });
    });
    
    /*
    socket.on('disconnect',function(){
      socket.emit('my event', {
        data: '{{username}} Disconnected'
      });
    });
    */
  });
  </script>
  </body>
</html>